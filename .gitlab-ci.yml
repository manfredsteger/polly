stages:
  - sync
  - build
  - test

variables:
  NODE_VERSION: "22"

sync-from-github:
  stage: sync
  image: alpine:latest
  before_script:
    - apk add --no-cache git
  script:
    - git remote add github https://github.com/manfredsteger/polly.git || true
    - git fetch github
    - git checkout github/main
  artifacts:
    paths:
      - .
    expire_in: 1 hour

build:
  stage: build
  image: node:${NODE_VERSION}
  needs: ["sync-from-github"]
  script:
    - npm ci
    - npm run build
  artifacts:
    paths:
      - node_modules/
      - dist/
    expire_in: 1 hour

typescript-check:
  stage: test
  image: node:${NODE_VERSION}
  needs: ["build"]
  script:
    - npx tsc --noEmit
  allow_failure: false

unit-tests:
  stage: test
  image: node:${NODE_VERSION}
  needs: ["build"]
  services:
    - postgres:15
  variables:
    POSTGRES_DB: polly_test
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: postgres
    DATABASE_URL: "postgresql://postgres:postgres@postgres:5432/polly_test"
  script:
    - npx vitest run --reporter=verbose --reporter=junit --outputFile=test-results.xml
  artifacts:
    when: always
    reports:
      junit: test-results.xml
    expire_in: 1 week

integration-tests:
  stage: test
  image: node:${NODE_VERSION}
  needs: ["build"]
  services:
    - postgres:15
  variables:
    POSTGRES_DB: polly_test
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: postgres
    DATABASE_URL: "postgresql://postgres:postgres@postgres:5432/polly_test"
  script:
    - npx vitest run server/tests/integration --reporter=verbose
  allow_failure: true

api-tests:
  stage: test
  image: node:${NODE_VERSION}
  needs: ["build"]
  services:
    - postgres:15
  variables:
    POSTGRES_DB: polly_test
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: postgres
    DATABASE_URL: "postgresql://postgres:postgres@postgres:5432/polly_test"
  script:
    - npx vitest run server/tests/api --reporter=verbose
  allow_failure: true

auth-tests:
  stage: test
  image: node:${NODE_VERSION}
  needs: ["build"]
  services:
    - postgres:15
  variables:
    POSTGRES_DB: polly_test
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: postgres
    DATABASE_URL: "postgresql://postgres:postgres@postgres:5432/polly_test"
  script:
    - npx vitest run server/tests/auth --reporter=verbose
  allow_failure: true

poll-tests:
  stage: test
  image: node:${NODE_VERSION}
  needs: ["build"]
  services:
    - postgres:15
  variables:
    POSTGRES_DB: polly_test
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: postgres
    DATABASE_URL: "postgresql://postgres:postgres@postgres:5432/polly_test"
  script:
    - npx vitest run server/tests/polls --reporter=verbose
  allow_failure: true

e2e-tests:
  stage: test
  image: mcr.microsoft.com/playwright:v1.52.0-noble
  needs: ["build"]
  services:
    - postgres:15
  variables:
    POSTGRES_DB: polly_test
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: postgres
    DATABASE_URL: "postgresql://postgres:postgres@postgres:5432/polly_test"
    CI: "true"
  script:
    - npm run dev &
    - sleep 10
    - npx playwright test --reporter=list
  artifacts:
    when: always
    paths:
      - playwright-report/
      - test-results/
    expire_in: 1 week
  allow_failure: true
