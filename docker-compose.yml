# Polly - Docker Compose Configuration
# Zero-config deployment for quick evaluation
# Compatible with Docker Compose V2+
#
# Quick Start:
#   docker compose up -d
#   Open http://localhost:3080
#
# With Demo Data:
#   SEED_DEMO_DATA=true docker compose up -d
#
# Custom Admin Credentials:
#   ADMIN_USERNAME=myadmin ADMIN_PASSWORD=MySecurePass123! docker compose up -d
#   (Default: admin / Admin123!)
#
# Mobile Testing (QR-Code/Smartphone):
#   Use start-mobile.sh to auto-detect host IP:
#   ./start-mobile.sh        # Start with detected IP
#   ./start-mobile.sh demo   # With demo data
#   
#   Or set BASE_URL manually:
#   BASE_URL=http://192.168.1.100:3080 docker compose up -d
#
# Data Persistence:
#   - postgres_data: Database (survives rebuilds)
#   - uploads_data: Uploaded files (logos, etc.)
#   - Use 'make purge' to delete all data

services:
  # ============================================
  # PostgreSQL Database
  # ============================================
  postgres:
    image: postgres:16-alpine
    container_name: polly-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-polly}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-polly_secret}
      POSTGRES_DB: ${POSTGRES_DB:-polly}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-polly} -d ${POSTGRES_DB:-polly}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ============================================
  # Polly Application
  # ============================================
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: polly-app
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER:-polly}:${POSTGRES_PASSWORD:-polly_secret}@postgres:5432/${POSTGRES_DB:-polly}
      SESSION_SECRET: ${SESSION_SECRET:-change-this-in-production-to-a-secure-random-string}
      BASE_URL: ${BASE_URL:-http://localhost:3080}
      APP_URL: ${APP_URL:-http://localhost:3080}
      VITE_APP_URL: ${VITE_APP_URL:-http://localhost:3080}
      SMTP_HOST: ${SMTP_HOST:-}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_SECURE: ${SMTP_SECURE:-false}
      SMTP_USER: ${SMTP_USER:-}
      SMTP_PASSWORD: ${SMTP_PASSWORD:-}
      EMAIL_FROM: ${EMAIL_FROM:-noreply@localhost}
      KEYCLOAK_REALM: ${KEYCLOAK_REALM:-}
      KEYCLOAK_CLIENT_ID: ${KEYCLOAK_CLIENT_ID:-}
      KEYCLOAK_CLIENT_SECRET: ${KEYCLOAK_CLIENT_SECRET:-}
      KEYCLOAK_AUTH_SERVER_URL: ${KEYCLOAK_AUTH_SERVER_URL:-}
      NODE_ENV: ${NODE_ENV:-production}
      SEED_DEMO_DATA: ${SEED_DEMO_DATA:-false}
      DOCKER_ENV: "true"
      # Initial Admin (created on first start, updated if changed)
      ADMIN_USERNAME: ${ADMIN_USERNAME:-admin}
      ADMIN_EMAIL: ${ADMIN_EMAIL:-admin@polly.local}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD:-Admin123!}
      # ClamAV Antivirus Configuration
      CLAMAV_ENABLED: ${CLAMAV_ENABLED:-false}
      CLAMAV_HOST: ${CLAMAV_HOST:-localhost}
      CLAMAV_PORT: ${CLAMAV_PORT:-3310}
    ports:
      - "${APP_PORT:-3080}:5000"
    volumes:
      - uploads_data:/app/uploads
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:5000/api/v1/health"]
      interval: 30s
      timeout: 10s
      start_period: 30s
      retries: 3

  # ============================================
  # ClamAV Antivirus (Optional)
  # ============================================
  # Start with: docker compose --profile clamav up -d
  clamav:
    image: clamav/clamav-debian:latest
    container_name: polly-clamav
    profiles:
      - clamav
    restart: unless-stopped
    volumes:
      - clamav_data:/var/lib/clamav
    ports:
      - "${CLAMAV_PORT:-3310}:3310"
    environment:
      # Reduce memory footprint for small deployments
      CLAMAV_NO_FRESHCLAMD: "false"
      CLAMAV_NO_MILTERD: "true"
    healthcheck:
      test: ["CMD", "/usr/local/bin/clamdcheck.sh"]
      interval: 60s
      timeout: 10s
      start_period: 120s
      retries: 3

volumes:
  postgres_data:
  uploads_data:
  clamav_data:

networks:
  default:
    name: polly-network
