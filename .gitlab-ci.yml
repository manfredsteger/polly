stages:
  - sync
  - build
  - test
  - security

# Sync job: Verifies code sync from GitHub (pull-only, no push to GitLab)
# Note: All other jobs already fetch from GitHub directly, so this job
# only verifies that the trigger was received and logs the sync status.
sync-from-github:
  stage: sync
  image: alpine:latest
  variables:
    GIT_STRATEGY: clone
  rules:
    - if: $CI_PIPELINE_SOURCE == "trigger"
  before_script:
    - apk add --no-cache git
  script:
    - set -e
    - echo "GitHub sync trigger received"
    - git remote add github https://github.com/manfredsteger/polly.git || true
    - git fetch github main
    - echo "Latest GitHub commit:"
    - git log github/main -1 --oneline
    - echo "Current GitLab checkout commit:"
    - git log HEAD -1 --oneline
    - echo "Sync verification completed - all jobs will use GitHub code directly"

variables:
  NODE_VERSION: "22"
  GIT_STRATEGY: none
  CI: "true"
  npm_config_cache: "/tmp/.npm"

# Reusable script for cloning from GitHub (avoids git init issues)
# Note: Clears working directory first to avoid conflicts with downloaded artifacts
.github_clone: &github_clone
  - rm -rf /tmp/polly-src 2>/dev/null || true
  - find . -mindepth 1 -delete 2>/dev/null || rm -rf ./* ./.[!.]* 2>/dev/null || true
  - git clone --depth=1 https://github.com/manfredsteger/polly.git /tmp/polly-src
  - cp -r /tmp/polly-src/. .
  - rm -rf /tmp/polly-src

# Reusable script for npm install with cleanup (fixes error -116)
.npm_install: &npm_install
  - rm -rf node_modules 2>/dev/null || true
  - rm -rf /tmp/.npm 2>/dev/null || true
  - mkdir -p /tmp/.npm
  - npm ci --prefer-offline --no-audit

build:
  stage: build
  image: node:${NODE_VERSION}
  retry:
    max: 2
    when: unknown_failure
  before_script:
    - apt-get update && apt-get install -y git
    - *github_clone
  script:
    - *npm_install
    - npm run build
  artifacts:
    paths:
      - dist/
    expire_in: 1 hour

typescript-check:
  stage: test
  image: node:${NODE_VERSION}
  retry:
    max: 2
    when: unknown_failure
  before_script:
    - apt-get update && apt-get install -y git
    - *github_clone
  script:
    - *npm_install
    - npx tsc --noEmit
  allow_failure: false

unit-tests:
  stage: test
  image: node:${NODE_VERSION}
  retry:
    max: 2
    when: unknown_failure
  before_script:
    - apt-get update && apt-get install -y git
    - *github_clone
  services:
    - postgres:15
  variables:
    POSTGRES_DB: polly_test
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: postgres
    DATABASE_URL: "postgresql://postgres:postgres@postgres:5432/polly_test"
    SMTP_ENABLED: "false"
    SESSION_SECRET: "test-session-secret-minimum-32-characters-long"
  script:
    - *npm_install
    - npm run db:push
    - npx vitest run --reporter=verbose --reporter=junit --outputFile=test-results.xml
  artifacts:
    when: always
    reports:
      junit: test-results.xml
    expire_in: 1 week

integration-tests:
  stage: test
  image: node:${NODE_VERSION}
  retry:
    max: 2
    when: unknown_failure
  before_script:
    - apt-get update && apt-get install -y git
    - *github_clone
  services:
    - postgres:15
  variables:
    POSTGRES_DB: polly_test
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: postgres
    DATABASE_URL: "postgresql://postgres:postgres@postgres:5432/polly_test"
    SMTP_ENABLED: "false"
    SESSION_SECRET: "test-session-secret-minimum-32-characters-long"
  script:
    - *npm_install
    - npm run db:push
    - npx vitest run server/tests/integration --reporter=verbose
  allow_failure: true

api-tests:
  stage: test
  image: node:${NODE_VERSION}
  retry:
    max: 2
    when: unknown_failure
  before_script:
    - apt-get update && apt-get install -y git
    - *github_clone
  services:
    - postgres:15
  variables:
    POSTGRES_DB: polly_test
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: postgres
    DATABASE_URL: "postgresql://postgres:postgres@postgres:5432/polly_test"
    SMTP_ENABLED: "false"
    SESSION_SECRET: "test-session-secret-minimum-32-characters-long"
  script:
    - *npm_install
    - npm run db:push
    - npx vitest run server/tests/api --reporter=verbose
  allow_failure: true

auth-tests:
  stage: test
  image: node:${NODE_VERSION}
  retry:
    max: 2
    when: unknown_failure
  before_script:
    - apt-get update && apt-get install -y git
    - *github_clone
  services:
    - postgres:15
  variables:
    POSTGRES_DB: polly_test
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: postgres
    DATABASE_URL: "postgresql://postgres:postgres@postgres:5432/polly_test"
    SMTP_ENABLED: "false"
    SESSION_SECRET: "test-session-secret-minimum-32-characters-long"
  script:
    - *npm_install
    - npm run db:push
    - npx vitest run server/tests/auth --reporter=verbose
  allow_failure: true

poll-tests:
  stage: test
  image: node:${NODE_VERSION}
  retry:
    max: 2
    when: unknown_failure
  before_script:
    - apt-get update && apt-get install -y git
    - *github_clone
  services:
    - postgres:15
  variables:
    POSTGRES_DB: polly_test
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: postgres
    DATABASE_URL: "postgresql://postgres:postgres@postgres:5432/polly_test"
    SMTP_ENABLED: "false"
    SESSION_SECRET: "test-session-secret-minimum-32-characters-long"
  script:
    - *npm_install
    - npm run db:push
    - npx vitest run server/tests/polls --reporter=verbose
  allow_failure: true

e2e-tests:
  stage: test
  image: mcr.microsoft.com/playwright:v1.52.0-noble
  retry:
    max: 2
    when: unknown_failure
  before_script:
    - rm -rf /tmp/polly-src 2>/dev/null || true
    - git clone --depth=1 https://github.com/manfredsteger/polly.git /tmp/polly-src
    - cp -r /tmp/polly-src/. .
    - rm -rf /tmp/polly-src
    - mkdir -p playwright-report test-results
  services:
    - postgres:15
  variables:
    POSTGRES_DB: polly_test
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: postgres
    DATABASE_URL: "postgresql://postgres:postgres@postgres:5432/polly_test"
    SESSION_SECRET: "e2e-test-session-secret-minimum-32-characters-long"
    BASE_URL: "http://localhost:5000"
    SMTP_ENABLED: "false"
    NODE_ENV: "test"
    npm_config_cache: "/tmp/.npm"
  script:
    - rm -rf node_modules 2>/dev/null || true
    - rm -rf /tmp/.npm 2>/dev/null || true
    - mkdir -p /tmp/.npm
    - npm ci --prefer-offline --no-audit
    - npm run db:push
    - npm run dev &
    - sleep 15
    - npx playwright test --reporter=list --timeout=60000 || true
  artifacts:
    when: always
    paths:
      - playwright-report/
      - test-results/
    expire_in: 1 week
  allow_failure: true

security-audit:
  stage: security
  image: node:${NODE_VERSION}
  retry:
    max: 2
    when: unknown_failure
  before_script:
    - apt-get update && apt-get install -y git
    - *github_clone
  script:
    - *npm_install
    - npm audit --audit-level=high || true
  allow_failure: true
