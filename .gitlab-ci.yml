stages:
  - sync
  - build
  - test
  - security

# Sync job: Pulls latest code from GitHub when triggered via pipeline trigger
sync-from-github:
  stage: sync
  image: alpine:latest
  variables:
    GIT_STRATEGY: clone
  rules:
    - if: $CI_PIPELINE_SOURCE == "trigger"
  before_script:
    - apk add --no-cache git
  script:
    - set -e
    - git config --global user.email "gitlab@kita.bayern"
    - git config --global user.name "GitLab Sync Bot"
    - echo "Fetching latest code from GitHub..."
    - git remote add github https://github.com/manfredsteger/polly.git || true
    - git fetch github main
    - echo "Syncing GitHub main to GitLab..."
    - git checkout -B main github/main
    - git push -f origin main
    - echo "Sync completed successfully"

variables:
  NODE_VERSION: "22"
  GIT_STRATEGY: none
  CI: "true"

build:
  stage: build
  image: node:${NODE_VERSION}
  before_script:
    - apt-get update && apt-get install -y git
    - rm -rf .git test-results playwright-report || true
    - git init
    - git remote add github https://github.com/manfredsteger/polly.git || true
    - git fetch --force github main --depth=1
    - git checkout -f FETCH_HEAD
  script:
    - npm cache clean --force
    - npm ci
    - npm run build
  artifacts:
    paths:
      - dist/
    expire_in: 1 hour

typescript-check:
  stage: test
  image: node:${NODE_VERSION}
  before_script:
    - apt-get update && apt-get install -y git
    - rm -rf .git test-results playwright-report || true
    - git init
    - git remote add github https://github.com/manfredsteger/polly.git || true
    - git fetch --force github main --depth=1
    - git checkout -f FETCH_HEAD
  script:
    - npm cache clean --force
    - npm ci
    - npx tsc --noEmit
  allow_failure: false

unit-tests:
  stage: test
  image: node:${NODE_VERSION}
  before_script:
    - apt-get update && apt-get install -y git
    - rm -rf .git test-results playwright-report || true
    - git init
    - git remote add github https://github.com/manfredsteger/polly.git || true
    - git fetch --force github main --depth=1
    - git checkout -f FETCH_HEAD
  services:
    - postgres:15
  variables:
    POSTGRES_DB: polly_test
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: postgres
    DATABASE_URL: "postgresql://postgres:postgres@postgres:5432/polly_test"
    SMTP_ENABLED: "false"
    SESSION_SECRET: "test-session-secret-minimum-32-characters-long"
  script:
    - npm cache clean --force
    - npm ci
    - npm run db:push
    - npx vitest run --reporter=verbose --reporter=junit --outputFile=test-results.xml
  artifacts:
    when: always
    reports:
      junit: test-results.xml
    expire_in: 1 week

integration-tests:
  stage: test
  image: node:${NODE_VERSION}
  before_script:
    - apt-get update && apt-get install -y git
    - rm -rf .git test-results playwright-report || true
    - git init
    - git remote add github https://github.com/manfredsteger/polly.git || true
    - git fetch --force github main --depth=1
    - git checkout -f FETCH_HEAD
  services:
    - postgres:15
  variables:
    POSTGRES_DB: polly_test
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: postgres
    DATABASE_URL: "postgresql://postgres:postgres@postgres:5432/polly_test"
    SMTP_ENABLED: "false"
    SESSION_SECRET: "test-session-secret-minimum-32-characters-long"
  script:
    - npm cache clean --force
    - npm ci
    - npm run db:push
    - npx vitest run server/tests/integration --reporter=verbose
  allow_failure: true

api-tests:
  stage: test
  image: node:${NODE_VERSION}
  before_script:
    - apt-get update && apt-get install -y git
    - rm -rf .git test-results playwright-report || true
    - git init
    - git remote add github https://github.com/manfredsteger/polly.git || true
    - git fetch --force github main --depth=1
    - git checkout -f FETCH_HEAD
  services:
    - postgres:15
  variables:
    POSTGRES_DB: polly_test
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: postgres
    DATABASE_URL: "postgresql://postgres:postgres@postgres:5432/polly_test"
    SMTP_ENABLED: "false"
    SESSION_SECRET: "test-session-secret-minimum-32-characters-long"
  script:
    - npm cache clean --force
    - npm ci
    - npm run db:push
    - npx vitest run server/tests/api --reporter=verbose
  allow_failure: true

auth-tests:
  stage: test
  image: node:${NODE_VERSION}
  before_script:
    - apt-get update && apt-get install -y git
    - rm -rf .git test-results playwright-report || true
    - git init
    - git remote add github https://github.com/manfredsteger/polly.git || true
    - git fetch --force github main --depth=1
    - git checkout -f FETCH_HEAD
  services:
    - postgres:15
  variables:
    POSTGRES_DB: polly_test
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: postgres
    DATABASE_URL: "postgresql://postgres:postgres@postgres:5432/polly_test"
    SMTP_ENABLED: "false"
    SESSION_SECRET: "test-session-secret-minimum-32-characters-long"
  script:
    - npm cache clean --force
    - npm ci
    - npm run db:push
    - npx vitest run server/tests/auth --reporter=verbose
  allow_failure: true

poll-tests:
  stage: test
  image: node:${NODE_VERSION}
  before_script:
    - apt-get update && apt-get install -y git
    - rm -rf .git test-results playwright-report || true
    - git init
    - git remote add github https://github.com/manfredsteger/polly.git || true
    - git fetch --force github main --depth=1
    - git checkout -f FETCH_HEAD
  services:
    - postgres:15
  variables:
    POSTGRES_DB: polly_test
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: postgres
    DATABASE_URL: "postgresql://postgres:postgres@postgres:5432/polly_test"
    SMTP_ENABLED: "false"
    SESSION_SECRET: "test-session-secret-minimum-32-characters-long"
  script:
    - npm cache clean --force
    - npm ci
    - npm run db:push
    - npx vitest run server/tests/polls --reporter=verbose
  allow_failure: true

e2e-tests:
  stage: test
  image: mcr.microsoft.com/playwright:v1.52.0-noble
  before_script:
    - rm -rf .git test-results playwright-report || true
    - git init
    - git remote add github https://github.com/manfredsteger/polly.git || true
    - git fetch --force github main --depth=1
    - git checkout -f FETCH_HEAD
  services:
    - postgres:15
  variables:
    POSTGRES_DB: polly_test
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: postgres
    DATABASE_URL: "postgresql://postgres:postgres@postgres:5432/polly_test"
    SESSION_SECRET: "e2e-test-session-secret-minimum-32-characters-long"
    BASE_URL: "http://localhost:5000"
    SMTP_ENABLED: "false"
    NODE_ENV: "test"
  script:
    - npm cache clean --force
    - npm ci
    - npm run db:push
    - npm run dev &
    - sleep 15
    - npx playwright test --reporter=list --timeout=60000
  artifacts:
    when: always
    paths:
      - playwright-report/
      - test-results/
    expire_in: 1 week
  allow_failure: true

security-audit:
  stage: security
  image: node:${NODE_VERSION}
  before_script:
    - apt-get update && apt-get install -y git
    - rm -rf .git test-results playwright-report || true
    - git init
    - git remote add github https://github.com/manfredsteger/polly.git || true
    - git fetch --force github main --depth=1
    - git checkout -f FETCH_HEAD
  script:
    - npm cache clean --force
    - npm ci
    - npm audit --audit-level=high || true
  allow_failure: true
