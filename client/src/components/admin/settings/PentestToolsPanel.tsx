import { useState } from "react";
import { useTranslation } from 'react-i18next';
import { useMutation, useQuery, useQueryClient } from "@tanstack/react-query";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Badge } from "@/components/ui/badge";
import { Label } from "@/components/ui/label";
import { useToast } from "@/hooks/use-toast";
import { apiRequest } from "@/lib/queryClient";
import { Alert, AlertDescription } from "@/components/ui/alert";
import { Progress } from "@/components/ui/progress";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from "@/components/ui/table";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog";
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from "@/components/ui/tooltip";
import { 
  Shield,
  Target,
  Lock,
  ArrowLeft,
  Loader2,
  CheckCircle2,
  XCircle,
  AlertTriangle,
  RefreshCw,
  Play,
  Square,
  Save,
  Trash2,
  Search,
  ShieldAlert,
  Eye,
  ExternalLink
} from "lucide-react";

interface PentestToolsStatus {
  configured: boolean;
  configuredViaEnv: boolean;
  connected: boolean;
  message?: string;
  account?: {
    email?: string;
    plan?: string;
  };
}

interface PentestTool {
  id: number;
  name: string;
  category: string;
}

interface ScanType {
  id: string;
  name: string;
}

interface ResultSummary {
  critical?: number;
  high?: number;
  medium?: number;
  low?: number;
  info?: number;
}

interface PentestScan {
  id: string;
  target: string;
  tool_id: number;
  tool_name: string;
  status: 'running' | 'finished' | 'stopped' | 'failed' | 'queued';
  progress?: number;
  started_at?: string;
  finished_at?: string;
  findings_count?: number;
  result_summary?: ResultSummary;
}

interface PentestFinding {
  id: string;
  title: string;
  severity: 'critical' | 'high' | 'medium' | 'low' | 'info';
  description?: string;
  solution?: string;
  affected_url?: string;
  cvss_score?: number;
  cwe_id?: string;
  reference?: string;
}

interface PollyTargetInfo {
  configured: boolean;
  url?: string;
  targetId?: number;
  workspaceId?: number;
  lastSynced?: string;
  error?: string;
}

export function PentestToolsPanel({ onBack }: { onBack: () => void }) {
  const { t } = useTranslation();
  const { toast } = useToast();
  const queryClient = useQueryClient();
  const [selectedScan, setSelectedScan] = useState<string | null>(null);
  const [newScanToolId, setNewScanToolId] = useState(170);
  const [newScanType, setNewScanType] = useState('light');
  const [isStartingScan, setIsStartingScan] = useState(false);
  const [tokenInput, setTokenInput] = useState('');
  const [isSavingToken, setIsSavingToken] = useState(false);
  const [isSyncingTarget, setIsSyncingTarget] = useState(false);
  const [severityFilter, setSeverityFilter] = useState<string>('all');
  const [hiddenScanIds, setHiddenScanIds] = useState<Set<string>>(new Set());

  const { data: status, isLoading: isLoadingStatus, refetch: refetchStatus } = useQuery<PentestToolsStatus>({
    queryKey: ['/api/v1/admin/pentest-tools/status'],
    refetchInterval: 30000,
  });

  const { data: targetInfo, refetch: refetchTarget } = useQuery<PollyTargetInfo>({
    queryKey: ['/api/v1/admin/pentest-tools/target'],
    enabled: status?.configured === true && status?.connected === true,
  });

  const saveTokenMutation = useMutation({
    mutationFn: async (apiToken: string) => {
      const response = await apiRequest('POST', '/api/v1/admin/pentest-tools/config', { apiToken });
      return response.json();
    },
    onSuccess: () => {
      toast({ title: t('admin.pentest.tokenSaved'), description: t('admin.pentest.tokenSavedDescription') });
      setTokenInput('');
      queryClient.invalidateQueries({ queryKey: ['/api/v1/admin/pentest-tools/status'] });
    },
    onError: (error: any) => {
      toast({ title: t('errors.generic'), description: error.message || t('admin.tests.tokenSaveError'), variant: "destructive" });
    },
    onSettled: () => {
      setIsSavingToken(false);
    }
  });

  const handleSaveToken = () => {
    if (!tokenInput.trim()) {
      toast({ title: t('errors.generic'), description: t('admin.tests.pleaseEnterToken'), variant: "destructive" });
      return;
    }
    setIsSavingToken(true);
    saveTokenMutation.mutate(tokenInput.trim());
  };

  const { data: toolsData } = useQuery<{ tools: PentestTool[]; scanTypes: ScanType[] }>({
    queryKey: ['/api/v1/admin/pentest-tools/tools'],
    enabled: status?.configured === true,
  });

  const { data: scansData, isLoading: isLoadingScans, refetch: refetchScans } = useQuery<{ scans: PentestScan[] }>({
    queryKey: ['/api/v1/admin/pentest-tools/scans'],
    enabled: status?.configured === true,
    refetchInterval: 10000,
  });

  const { data: findingsData, isLoading: isLoadingFindings } = useQuery<{ findings: PentestFinding[] }>({
    queryKey: ['/api/v1/admin/pentest-tools/scans', selectedScan, 'findings'],
    queryFn: async () => {
      const response = await fetch(`/api/v1/admin/pentest-tools/scans/${selectedScan}/findings`, { credentials: 'include' });
      if (!response.ok) throw new Error('Failed to fetch findings');
      return response.json();
    },
    enabled: !!selectedScan,
  });

  const syncTargetMutation = useMutation({
    mutationFn: async () => {
      const response = await apiRequest('POST', '/api/v1/admin/pentest-tools/target/sync');
      return response.json();
    },
    onSuccess: () => {
      toast({ title: t('admin.tests.targetSynced'), description: t('admin.tests.targetSyncedDescription') });
      queryClient.invalidateQueries({ queryKey: ['/api/v1/admin/pentest-tools/target'] });
    },
    onError: (error: any) => {
      toast({ title: t('errors.generic'), description: error.message || t('admin.tests.targetSyncError'), variant: "destructive" });
    },
    onSettled: () => {
      setIsSyncingTarget(false);
    }
  });

  const startScanMutation = useMutation({
    mutationFn: async (data: { toolId: number; scanType: string }) => {
      const response = await apiRequest('POST', '/api/v1/admin/pentest-tools/scans', data);
      return response.json();
    },
    onSuccess: (data) => {
      toast({ title: t('admin.pentest.scanStarted'), description: t('admin.pentest.scanStartedDescription', { scanId: data.scan_id }) });
      queryClient.invalidateQueries({ queryKey: ['/api/v1/admin/pentest-tools/scans'] });
      queryClient.invalidateQueries({ queryKey: ['/api/v1/admin/pentest-tools/target'] });
    },
    onError: (error: any) => {
      toast({ title: t('errors.generic'), description: error.message || t('admin.tests.scanStartError'), variant: "destructive" });
    },
    onSettled: () => {
      setIsStartingScan(false);
    }
  });

  const stopScanMutation = useMutation({
    mutationFn: async (scanId: string) => {
      const response = await apiRequest('POST', `/api/v1/admin/pentest-tools/scans/${scanId}/stop`);
      return response.json();
    },
    onSuccess: () => {
      toast({ title: t('admin.tests.scanStopped'), description: t('admin.tests.scanStoppedDescription') });
      queryClient.invalidateQueries({ queryKey: ['/api/v1/admin/pentest-tools/scans'] });
    },
    onError: () => {
      toast({ title: t('errors.generic'), description: t('admin.tests.scanStopError'), variant: "destructive" });
    }
  });

  const handleSyncTarget = () => {
    setIsSyncingTarget(true);
    syncTargetMutation.mutate();
  };

  const handleStartScan = () => {
    setIsStartingScan(true);
    startScanMutation.mutate({ toolId: newScanToolId, scanType: newScanType });
  };

  const getSeverityColor = (severity: string) => {
    switch (severity) {
      case 'critical': return 'bg-red-600 text-white';
      case 'high': return 'bg-orange-500 text-white';
      case 'medium': return 'bg-yellow-500 text-black';
      case 'low': return 'bg-blue-500 text-white';
      default: return 'bg-gray-500 text-white';
    }
  };

  const getStatusBadge = (status: string) => {
    switch (status) {
      case 'running': return <Badge className="bg-blue-500">{t('admin.pentest.status.running')}</Badge>;
      case 'finished': return <Badge className="bg-green-500">{t('admin.pentest.status.finished')}</Badge>;
      case 'stopped': return <Badge className="bg-gray-500">{t('admin.pentest.status.stopped')}</Badge>;
      case 'failed': return <Badge className="bg-red-500">{t('admin.pentest.status.failed')}</Badge>;
      case 'queued': return <Badge className="bg-yellow-500">{t('admin.pentest.status.queued')}</Badge>;
      default: return <Badge>{status}</Badge>;
    }
  };

  const formatDate = (dateStr?: string) => {
    if (!dateStr) return '-';
    try {
      return new Date(dateStr).toLocaleString('de-DE');
    } catch {
      return dateStr;
    }
  };

  if (isLoadingStatus) {
    return (
      <div className="space-y-6">
        <div className="flex items-center gap-2">
          <Button variant="ghost" size="sm" onClick={onBack}>
            <ArrowLeft className="w-4 h-4 mr-2" />
            {t('admin.pentest.backToSettings')}
          </Button>
        </div>
        <Card className="polly-card">
          <CardContent className="p-8 flex justify-center">
            <Loader2 className="w-8 h-8 animate-spin text-muted-foreground" />
          </CardContent>
        </Card>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      <div className="flex items-center gap-2">
        <Button variant="ghost" size="sm" onClick={onBack} data-testid="button-back-pentest">
          <ArrowLeft className="w-4 h-4 mr-2" />
          {t('admin.pentest.backToSettings')}
        </Button>
        <h2 className="text-2xl font-semibold text-foreground">{t('admin.pentest.title')}</h2>
      </div>

      <Card className="polly-card">
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <Shield className="w-5 h-5" />
            {t('admin.pentest.connectionStatus')}
          </CardTitle>
        </CardHeader>
        <CardContent>
          <div className="flex items-center gap-4">
            {status?.configured ? (
              status.connected ? (
                <>
                  <div className="flex items-center gap-2 text-green-600 dark:text-green-400">
                    <CheckCircle2 className="w-5 h-5" />
                    <span className="font-medium">{t('admin.pentest.connected')}</span>
                  </div>
                  {status.account && (
                    <div className="text-sm text-muted-foreground">
                      {status.account.email && <span>Account: {status.account.email}</span>}
                      {status.account.plan && <span className="ml-4">Plan: {status.account.plan}</span>}
                    </div>
                  )}
                </>
              ) : (
                <div className="flex items-center gap-2 text-red-600 dark:text-red-400">
                  <XCircle className="w-5 h-5" />
                  <span className="font-medium">{t('admin.pentest.connectionError')}: {status.message}</span>
                </div>
              )
            ) : (
              <div className="flex items-center gap-2 text-yellow-600 dark:text-yellow-400">
                <AlertTriangle className="w-5 h-5" />
                <span className="font-medium">{t('admin.pentest.apiTokenNotConfigured')}</span>
              </div>
            )}
          </div>
          
          {status?.configuredViaEnv ? (
            <Alert className="mt-4">
              <Lock className="h-4 w-4" />
              <AlertDescription>{t('admin.pentest.apiTokenEnvNote')}</AlertDescription>
            </Alert>
          ) : (
            <div className="mt-4 space-y-3">
              <div className="space-y-2">
                <Label htmlFor="pentest-api-token">{t('admin.pentest.apiToken')}</Label>
                <div className="flex gap-2">
                  <Input
                    id="pentest-api-token"
                    type="password"
                    value={tokenInput}
                    onChange={(e) => setTokenInput(e.target.value)}
                    placeholder={status?.configured ? "‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" : t('admin.pentest.tokenPlaceholder')}
                    data-testid="input-pentest-token"
                    className="flex-1"
                  />
                  <Button onClick={handleSaveToken} disabled={isSavingToken || !tokenInput.trim()} data-testid="button-save-pentest-token">
                    {isSavingToken ? <Loader2 className="w-4 h-4 mr-2 animate-spin" /> : <Save className="w-4 h-4 mr-2" />}
                    {t('common.save')}
                  </Button>
                </div>
                <p className="text-xs text-muted-foreground">
                  {t('admin.pentest.createToken')}: <a href="https://app.pentest-tools.com/account/api" target="_blank" rel="noopener noreferrer" className="text-primary hover:underline">pentest-tools.com ‚Üí Account ‚Üí API</a>
                </p>
              </div>
            </div>
          )}
          
          {status?.configured && !status.connected && (
            <Alert variant="destructive" className="mt-4">
              <XCircle className="h-4 w-4" />
              <AlertDescription className="space-y-2">
                <p>{t('admin.pentest.possibleCauses')}</p>
                <ul className="list-disc list-inside text-sm space-y-1 ml-2">
                  <li>{t('admin.pentest.tokenInvalidOrExpired')}</li>
                  <li>{t('admin.pentest.networkProblems')}</li>
                  <li>{t('admin.pentest.accountNotActive')}</li>
                </ul>
              </AlertDescription>
            </Alert>
          )}
        </CardContent>
      </Card>

      {status?.configured && status.connected && (
        <>
          <Card className="polly-card">
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <Target className="w-5 h-5" />
                {t('admin.pentest.pollySecurityScan')}
              </CardTitle>
            </CardHeader>
            <CardContent className="space-y-4">
              <div className="p-4 bg-muted/50 rounded-lg border">
                <div className="flex items-center justify-between">
                  <div>
                    <Label className="text-sm text-muted-foreground">{t('admin.pentest.scanTarget')}</Label>
                    <div className="flex items-center gap-2 mt-1">
                      {targetInfo?.url ? (
                        <>
                          <code className="text-sm bg-background px-2 py-1 rounded border" data-testid="text-polly-url">{targetInfo.url}</code>
                          {targetInfo.configured && (
                            <Badge className="bg-green-500" data-testid="badge-target-synced">
                              <CheckCircle2 className="w-3 h-3 mr-1" />
                              {t('admin.pentest.synchronized')}
                            </Badge>
                          )}
                        </>
                      ) : (
                        <span className="text-muted-foreground text-sm">{t('admin.pentest.urlBeingDetermined')}</span>
                      )}
                    </div>
                    {targetInfo?.lastSynced && (
                      <p className="text-xs text-muted-foreground mt-1">{t('admin.pentest.lastSynced')}: {formatDate(targetInfo.lastSynced)}</p>
                    )}
                  </div>
                  <Button variant="outline" size="sm" onClick={handleSyncTarget} disabled={isSyncingTarget} data-testid="button-sync-target">
                    {isSyncingTarget ? <Loader2 className="w-4 h-4 mr-2 animate-spin" /> : <RefreshCw className="w-4 h-4 mr-2" />}
                    {t('admin.pentest.syncTarget')}
                  </Button>
                </div>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <Label htmlFor="scan-tool">{t('admin.pentest.scanTool')}</Label>
                  <Select value={String(newScanToolId)} onValueChange={(v) => setNewScanToolId(parseInt(v))}>
                    <SelectTrigger data-testid="select-scan-tool"><SelectValue /></SelectTrigger>
                    <SelectContent>
                      {toolsData?.tools.map((tool) => (
                        <SelectItem key={tool.id} value={String(tool.id)}>{tool.name}</SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>
                <div>
                  <Label htmlFor="scan-type">{t('admin.pentest.scanDepth')}</Label>
                  <Select value={newScanType} onValueChange={setNewScanType}>
                    <SelectTrigger data-testid="select-scan-type"><SelectValue /></SelectTrigger>
                    <SelectContent>
                      {toolsData?.scanTypes.map((type) => (
                        <SelectItem key={type.id} value={type.id}>{type.name}</SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>
              </div>
              
              <div className="flex items-center gap-4">
                <Button onClick={handleStartScan} disabled={isStartingScan || !targetInfo?.url} data-testid="button-start-scan">
                  {isStartingScan ? <Loader2 className="w-4 h-4 mr-2 animate-spin" /> : <Play className="w-4 h-4 mr-2" />}
                  {t('admin.pentest.scanPolly')}
                </Button>
                <Button variant="outline" onClick={() => refetchScans()} data-testid="button-refresh-scans">
                  <RefreshCw className="w-4 h-4 mr-2" />
                  {t('common.refresh')}
                </Button>
              </div>
            </CardContent>
          </Card>

          <Card className="polly-card">
            <CardHeader className="flex flex-row items-center justify-between">
              <CardTitle className="flex items-center gap-2">
                <Search className="w-5 h-5" />
                {t('admin.pentest.recentScans')}
              </CardTitle>
              {scansData?.scans && scansData.scans.filter(s => !hiddenScanIds.has(s.id)).length > 0 && (
                <TooltipProvider>
                  <Tooltip>
                    <TooltipTrigger asChild>
                      <Button 
                        variant="ghost" 
                        size="sm"
                        className="text-muted-foreground hover:text-destructive"
                        onClick={() => {
                          const allIds = new Set(scansData.scans.map(s => s.id));
                          setHiddenScanIds(allIds);
                          toast({ title: t('admin.pentest.listCleared'), description: t('admin.pentest.listClearedDescription') });
                        }}
                        data-testid="button-clear-scans"
                      >
                        <Trash2 className="w-4 h-4" />
                      </Button>
                    </TooltipTrigger>
                    <TooltipContent><p>{t('admin.pentest.clearListOnly')}</p></TooltipContent>
                  </Tooltip>
                </TooltipProvider>
              )}
            </CardHeader>
            <CardContent>
              {isLoadingScans ? (
                <div className="flex justify-center py-8">
                  <Loader2 className="w-8 h-8 animate-spin text-muted-foreground" />
                </div>
              ) : scansData?.scans && scansData.scans.filter(s => !hiddenScanIds.has(s.id)).length > 0 ? (
                <Table>
                  <TableHeader>
                    <TableRow>
                      <TableHead>{t('admin.pentest.tableTarget')}</TableHead>
                      <TableHead>{t('admin.pentest.tableTool')}</TableHead>
                      <TableHead>{t('admin.pentest.tableStatus')}</TableHead>
                      <TableHead>{t('admin.pentest.tableProgress')}</TableHead>
                      <TableHead>{t('admin.pentest.tableStarted')}</TableHead>
                      <TableHead>{t('admin.pentest.findings')}</TableHead>
                      <TableHead>{t('admin.pentest.tableActions')}</TableHead>
                    </TableRow>
                  </TableHeader>
                  <TableBody>
                    {scansData.scans.filter(s => !hiddenScanIds.has(s.id)).map((scan) => (
                      <TableRow key={scan.id} data-testid={`row-scan-${scan.id}`}>
                        <TableCell className="max-w-[200px] truncate" title={scan.target}>{scan.target}</TableCell>
                        <TableCell>{scan.tool_name}</TableCell>
                        <TableCell>{getStatusBadge(scan.status)}</TableCell>
                        <TableCell>
                          {scan.status === 'running' && scan.progress !== undefined ? (
                            <div className="flex items-center gap-2">
                              <Progress value={scan.progress} className="w-20" />
                              <span className="text-sm">{scan.progress}%</span>
                            </div>
                          ) : '-'}
                        </TableCell>
                        <TableCell className="text-sm">{formatDate(scan.started_at)}</TableCell>
                        <TableCell>
                          {scan.result_summary && (scan.result_summary.critical || scan.result_summary.high || scan.result_summary.medium || scan.result_summary.low || scan.result_summary.info) ? (
                            <div className="flex flex-wrap gap-1">
                              {scan.result_summary.critical ? <Badge className="bg-red-800 text-white text-xs px-1.5">{scan.result_summary.critical}</Badge> : null}
                              {scan.result_summary.high ? <Badge className="bg-orange-900 text-white text-xs px-1.5">{scan.result_summary.high}</Badge> : null}
                              {scan.result_summary.medium ? <Badge className="bg-amber-800 text-white text-xs px-1.5">{scan.result_summary.medium}</Badge> : null}
                              {scan.result_summary.low ? <Badge className="bg-blue-600 text-white text-xs px-1.5">{scan.result_summary.low}</Badge> : null}
                              {scan.result_summary.info ? <Badge className="bg-gray-700 text-white text-xs px-1.5">{scan.result_summary.info}</Badge> : null}
                            </div>
                          ) : scan.status === 'finished' ? <Badge variant="secondary">0</Badge> : '-'}
                        </TableCell>
                        <TableCell>
                          <div className="flex gap-2">
                            {scan.status === 'finished' && (
                              <Button variant="outline" size="sm" onClick={() => { setSeverityFilter('all'); setSelectedScan(scan.id); }} data-testid={`button-view-findings-${scan.id}`}>
                                <Eye className="w-4 h-4 mr-1" />
                                {t('admin.pentest.findings')}
                              </Button>
                            )}
                            {scan.status === 'running' && (
                              <Button variant="destructive" size="sm" onClick={() => stopScanMutation.mutate(scan.id)} data-testid={`button-stop-scan-${scan.id}`}>
                                <Square className="w-4 h-4 mr-1" />
                                {t('common.stop')}
                              </Button>
                            )}
                          </div>
                        </TableCell>
                      </TableRow>
                    ))}
                  </TableBody>
                </Table>
              ) : (
                <div className="text-center py-8 text-muted-foreground">
                  <Search className="w-12 h-12 mx-auto mb-4 opacity-50" />
                  <p>{t('admin.pentest.noScansYet')}</p>
                  <p className="text-sm">{t('admin.pentest.startFirstScan')}</p>
                </div>
              )}
            </CardContent>
          </Card>

          {selectedScan && (
            <Dialog open={!!selectedScan} onOpenChange={() => setSelectedScan(null)}>
              <DialogContent className="max-w-4xl max-h-[80vh] overflow-y-auto">
                <DialogHeader>
                  <DialogTitle className="flex items-center gap-2">
                    <ShieldAlert className="w-5 h-5" />
                    {t('admin.pentest.scanResults')}
                  </DialogTitle>
                </DialogHeader>
                
                {isLoadingFindings ? (
                  <div className="flex justify-center py-8">
                    <Loader2 className="w-8 h-8 animate-spin" />
                  </div>
                ) : findingsData?.findings && findingsData.findings.length > 0 ? (
                  <div className="space-y-4">
                    <div className="flex items-center justify-between gap-4 flex-wrap">
                      <div className="flex gap-2 flex-wrap">
                        {['critical', 'high', 'medium', 'low', 'info'].map((sev) => {
                          const count = findingsData.findings.filter(f => f.severity === sev).length;
                          if (count === 0) return null;
                          return <Badge key={sev} className={getSeverityColor(sev)}>{sev.toUpperCase()}: {count}</Badge>;
                        })}
                      </div>
                      <div className="flex items-center gap-2">
                        <Label className="text-sm whitespace-nowrap">Filter:</Label>
                        <Select value={severityFilter} onValueChange={setSeverityFilter}>
                          <SelectTrigger className="w-[180px]" data-testid="select-severity-filter"><SelectValue placeholder={t('admin.pentest.filterShowAll')} /></SelectTrigger>
                          <SelectContent>
                            <SelectItem value="all">{t('admin.pentest.filterShowAll')}</SelectItem>
                            <SelectItem value="critical">üî¥ {t('admin.pentest.filterCriticalOnly')}</SelectItem>
                            <SelectItem value="high">üü† {t('admin.pentest.filterCriticalHigh')}</SelectItem>
                            <SelectItem value="medium">üü° {t('admin.pentest.filterToMedium')}</SelectItem>
                            <SelectItem value="low">üîµ {t('admin.pentest.filterToLow')}</SelectItem>
                            <SelectItem value="info">‚ÑπÔ∏è {t('admin.pentest.filterAllIncInfo')}</SelectItem>
                          </SelectContent>
                        </Select>
                      </div>
                    </div>
                    
                    <div className="space-y-3">
                      {findingsData.findings
                        .filter((finding) => {
                          if (severityFilter === 'all' || severityFilter === 'info') return true;
                          const severityOrder = ['critical', 'high', 'medium', 'low', 'info'];
                          const filterIndex = severityOrder.indexOf(severityFilter);
                          const findingIndex = severityOrder.indexOf(finding.severity);
                          return findingIndex <= filterIndex;
                        })
                        .map((finding) => (
                        <Card key={finding.id} className="border" data-testid={`finding-${finding.id}`}>
                          <CardContent className="p-4">
                            <div className="flex items-start justify-between gap-4">
                              <div className="flex-1">
                                <div className="flex items-center gap-2 mb-2 flex-wrap">
                                  <Badge className={getSeverityColor(finding.severity)}>{finding.severity.toUpperCase()}</Badge>
                                  {finding.cvss_score && <Badge variant="outline">CVSS: {finding.cvss_score}</Badge>}
                                  {finding.cwe_id && (
                                    <a href={`https://cwe.mitre.org/data/definitions/${finding.cwe_id.replace('CWE-', '')}.html`} target="_blank" rel="noopener noreferrer" className="inline-flex">
                                      <Badge variant="outline" className="hover:bg-blue-100 dark:hover:bg-blue-900 cursor-pointer">{finding.cwe_id}</Badge>
                                    </a>
                                  )}
                                </div>
                                <h4 className="font-semibold text-base">{finding.title}</h4>
                                {finding.affected_url && (
                                  <p className="text-sm text-muted-foreground mt-1 break-all font-mono bg-muted/50 px-2 py-1 rounded">{finding.affected_url}</p>
                                )}
                                {finding.description && <p className="text-sm mt-3 text-muted-foreground">{finding.description}</p>}
                                {finding.solution && (
                                  <div className="mt-3 p-3 bg-green-50 dark:bg-green-950/50 border border-green-200 dark:border-green-800 rounded-lg text-sm">
                                    <div className="flex items-start gap-2">
                                      <CheckCircle2 className="w-4 h-4 text-green-600 mt-0.5 flex-shrink-0" />
                                      <div>
                                        <strong className="text-green-700 dark:text-green-400">{t('admin.pentest.recommendedSolution')}</strong>
                                        <p className="mt-1">{finding.solution}</p>
                                      </div>
                                    </div>
                                  </div>
                                )}
                                {finding.reference && (
                                  <div className="mt-2">
                                    <a href={finding.reference} target="_blank" rel="noopener noreferrer" className="text-sm text-blue-600 dark:text-blue-400 hover:underline inline-flex items-center gap-1">
                                      <ExternalLink className="w-3 h-3" />
                                      Mehr Informationen
                                    </a>
                                  </div>
                                )}
                              </div>
                            </div>
                          </CardContent>
                        </Card>
                      ))}
                    </div>
                  </div>
                ) : (
                  <div className="text-center py-8 text-muted-foreground">
                    <CheckCircle2 className="w-12 h-12 mx-auto mb-4 text-green-500" />
                    <p>{t('admin.pentest.noSecurityIssues')}</p>
                  </div>
                )}
              </DialogContent>
            </Dialog>
          )}
        </>
      )}
    </div>
  );
}
