stages:
  - sync
  - build
  - test
  - security

# Sync job: Pulls code from GitHub and pushes to GitLab to keep repos in sync
# Uses GITLAB_TOKEN secret for authenticated push
sync-from-github:
  stage: sync
  image: alpine:latest
  variables:
    GIT_STRATEGY: clone
  rules:
    - if: $CI_PIPELINE_SOURCE == "trigger" || $CI_PIPELINE_SOURCE == "api"
  before_script:
    - apk add --no-cache git
  script:
    - set -e
    - echo "GitHub sync trigger received"
    - git config --global user.email "ci@gitlab.com"
    - git config --global user.name "GitLab CI"
    # Fetch latest from GitHub (uses GITHUB_REPO_URL variable)
    - git remote add github "${GITHUB_REPO_URL}" || true
    - git fetch github main --depth=50
    - echo "Latest GitHub commit:"
    - git log github/main -1 --oneline
    - echo "Current GitLab checkout commit:"
    - git log HEAD -1 --oneline
    # Push GitHub code to GitLab (requires GITLAB_TOKEN with write access)
    - |
      if [ -n "$GITLAB_TOKEN" ]; then
        echo "Pushing GitHub code to GitLab..."
        git remote set-url origin "https://oauth2:${GITLAB_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git"
        git checkout -B main github/main
        git push origin main --force
        echo "Sync completed - GitLab now matches GitHub"
      else
        echo "WARNING: GITLAB_TOKEN not set - skipping push to GitLab"
        echo "To enable sync, add GITLAB_TOKEN as CI/CD variable with write_repository scope"
      fi

variables:
  NODE_VERSION: "22"
  GIT_STRATEGY: none
  CI: "true"
  npm_config_cache: "/tmp/.npm"
  # Configure this in GitLab CI/CD Settings â†’ Variables for your own fork
  # Example: https://github.com/your-username/polly.git
  GITHUB_REPO_URL: "https://github.com/manfredsteger/polly.git"

# Reusable script for cloning from GitHub (avoids git init issues)
# Note: Clears working directory first to avoid conflicts with downloaded artifacts
# Uses GITHUB_REPO_URL variable - override in GitLab CI/CD settings for your fork
.github_clone: &github_clone
  - rm -rf /tmp/polly-src 2>/dev/null || true
  - find . -mindepth 1 -delete 2>/dev/null || rm -rf ./* ./.[!.]* 2>/dev/null || true
  - git clone --depth=1 "${GITHUB_REPO_URL}" /tmp/polly-src
  - cp -r /tmp/polly-src/. .
  - rm -rf /tmp/polly-src

# Reusable script for npm install with cleanup (fixes error -116)
.npm_install: &npm_install
  - rm -rf node_modules 2>/dev/null || true
  - rm -rf /tmp/.npm 2>/dev/null || true
  - mkdir -p /tmp/.npm
  - npm ci --prefer-offline --no-audit

# Reusable script for waiting until PostgreSQL is ready (fixes flaky tests)
.wait_for_postgres: &wait_for_postgres
  - |
    echo "Waiting for PostgreSQL to be ready..."
    for i in $(seq 1 30); do
      if pg_isready -h postgres -p 5432 -U postgres >/dev/null 2>&1; then
        echo "PostgreSQL is ready!"
        break
      fi
      echo "Attempt $i/30: PostgreSQL not ready yet, waiting..."
      sleep 2
    done
    if ! pg_isready -h postgres -p 5432 -U postgres >/dev/null 2>&1; then
      echo "ERROR: PostgreSQL did not become ready in time"
      exit 1
    fi

# Reusable script for waiting until the dev server is ready (fixes flaky e2e tests)
.wait_for_server: &wait_for_server
  - |
    echo "Waiting for dev server to be ready..."
    for i in $(seq 1 60); do
      if curl -s http://localhost:5000 >/dev/null 2>&1; then
        echo "Dev server is ready!"
        break
      fi
      echo "Attempt $i/60: Server not ready yet, waiting..."
      sleep 2
    done
    if ! curl -s http://localhost:5000 >/dev/null 2>&1; then
      echo "ERROR: Dev server did not become ready in time"
      exit 1
    fi

build:
  stage: build
  image: node:${NODE_VERSION}
  retry:
    max: 2
    when: unknown_failure
  before_script:
    - apt-get update && apt-get install -y git
    - *github_clone
  script:
    - *npm_install
    - npm run build
  artifacts:
    paths:
      - dist/
    expire_in: 1 hour

typescript-check:
  stage: test
  image: node:${NODE_VERSION}
  retry:
    max: 2
    when: unknown_failure
  before_script:
    - apt-get update && apt-get install -y git
    - *github_clone
  script:
    - *npm_install
    - npx tsc --noEmit
  allow_failure: false

validate-translations:
  stage: test
  image: node:${NODE_VERSION}
  retry:
    max: 2
    when: unknown_failure
  before_script:
    - apt-get update && apt-get install -y git
    - *github_clone
  script:
    - node scripts/validate-translations.cjs
  allow_failure: false

unit-tests:
  stage: test
  image: node:${NODE_VERSION}
  retry:
    max: 2
    when: unknown_failure
  before_script:
    - apt-get update && apt-get install -y git postgresql-client
    - *github_clone
  services:
    - postgres:15
  variables:
    POSTGRES_DB: polly_test
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: postgres
    DATABASE_URL: "postgresql://postgres:postgres@postgres:5432/polly_test"
    SMTP_ENABLED: "false"
    SESSION_SECRET: "test-session-secret-minimum-32-characters-long"
  script:
    - *npm_install
    - *wait_for_postgres
    - npm run db:push
    - npx vitest run --reporter=verbose --reporter=junit --outputFile=test-results.xml
  artifacts:
    when: always
    reports:
      junit: test-results.xml
    expire_in: 1 week

integration-tests:
  stage: test
  image: node:${NODE_VERSION}
  retry:
    max: 2
    when: unknown_failure
  before_script:
    - apt-get update && apt-get install -y git postgresql-client
    - *github_clone
  services:
    - postgres:15
  variables:
    POSTGRES_DB: polly_test
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: postgres
    DATABASE_URL: "postgresql://postgres:postgres@postgres:5432/polly_test"
    SMTP_ENABLED: "false"
    SESSION_SECRET: "test-session-secret-minimum-32-characters-long"
  script:
    - *npm_install
    - *wait_for_postgres
    - npm run db:push
    - npx vitest run server/tests/integration --reporter=verbose
  allow_failure: true

api-tests:
  stage: test
  image: node:${NODE_VERSION}
  retry:
    max: 2
    when: unknown_failure
  before_script:
    - apt-get update && apt-get install -y git postgresql-client
    - *github_clone
  services:
    - postgres:15
  variables:
    POSTGRES_DB: polly_test
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: postgres
    DATABASE_URL: "postgresql://postgres:postgres@postgres:5432/polly_test"
    SMTP_ENABLED: "false"
    SESSION_SECRET: "test-session-secret-minimum-32-characters-long"
  script:
    - *npm_install
    - *wait_for_postgres
    - npm run db:push
    - npx vitest run server/tests/api --reporter=verbose
  allow_failure: true

auth-tests:
  stage: test
  image: node:${NODE_VERSION}
  retry:
    max: 2
    when: unknown_failure
  before_script:
    - apt-get update && apt-get install -y git postgresql-client
    - *github_clone
  services:
    - postgres:15
  variables:
    POSTGRES_DB: polly_test
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: postgres
    DATABASE_URL: "postgresql://postgres:postgres@postgres:5432/polly_test"
    SMTP_ENABLED: "false"
    SESSION_SECRET: "test-session-secret-minimum-32-characters-long"
  script:
    - *npm_install
    - *wait_for_postgres
    - npm run db:push
    - npx vitest run server/tests/auth --reporter=verbose
  allow_failure: true

poll-tests:
  stage: test
  image: node:${NODE_VERSION}
  retry:
    max: 2
    when: unknown_failure
  before_script:
    - apt-get update && apt-get install -y git postgresql-client
    - *github_clone
  services:
    - postgres:15
  variables:
    POSTGRES_DB: polly_test
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: postgres
    DATABASE_URL: "postgresql://postgres:postgres@postgres:5432/polly_test"
    SMTP_ENABLED: "false"
    SESSION_SECRET: "test-session-secret-minimum-32-characters-long"
  script:
    - *npm_install
    - *wait_for_postgres
    - npm run db:push
    - npx vitest run server/tests/polls --reporter=verbose
  allow_failure: true

e2e-tests:
  stage: test
  image: mcr.microsoft.com/playwright:v1.52.0-noble
  retry:
    max: 2
    when: unknown_failure
  before_script:
    - rm -rf /tmp/polly-src 2>/dev/null || true
    - git clone --depth=1 "${GITHUB_REPO_URL}" /tmp/polly-src
    - cp -r /tmp/polly-src/. .
    - rm -rf /tmp/polly-src
    - mkdir -p playwright-report test-results
    - apt-get update && apt-get install -y postgresql-client curl
  services:
    - postgres:15
  variables:
    POSTGRES_DB: polly_test
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: postgres
    DATABASE_URL: "postgresql://postgres:postgres@postgres:5432/polly_test"
    SESSION_SECRET: "e2e-test-session-secret-minimum-32-characters-long"
    BASE_URL: "http://localhost:5000"
    SMTP_ENABLED: "false"
    NODE_ENV: "test"
    npm_config_cache: "/tmp/.npm"
  script:
    - rm -rf node_modules 2>/dev/null || true
    - rm -rf /tmp/.npm 2>/dev/null || true
    - mkdir -p /tmp/.npm
    - npm ci --prefer-offline --no-audit
    # Wait for PostgreSQL to be ready before db:push
    - *wait_for_postgres
    - npm run db:push
    - npm run dev &
    # Wait for dev server to be ready (replaces unreliable sleep 15)
    - *wait_for_server
    - npx playwright test --reporter=list --timeout=60000 || true
  artifacts:
    when: always
    paths:
      - playwright-report/
      - test-results/
    expire_in: 1 week
  allow_failure: true

security-audit:
  stage: security
  image: node:${NODE_VERSION}
  retry:
    max: 2
    when: unknown_failure
  before_script:
    - apt-get update && apt-get install -y git
    - *github_clone
  script:
    - *npm_install
    - npm audit --audit-level=high || true
  allow_failure: true
